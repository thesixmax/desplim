<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>The DESPLIM compactness score • desplim</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="The DESPLIM compactness score">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-dark" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">desplim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html">Overview</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/desplim-compactness.html">The DESPLIM compactness score</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Rereference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/thesixmax/desplim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>The DESPLIM compactness score</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/thesixmax/desplim/blob/main/vignettes/desplim-compactness.Rmd" class="external-link"><code>vignettes/desplim-compactness.Rmd</code></a></small>
      <div class="d-none name"><code>desplim-compactness.Rmd</code></div>
    </div>

    
    
<p>When evaluating districts, “compactness” is an important feature. But
what makes a district compact? Often, it comes down to the human
intuition of “you know it when you see it”, which has historically been
hard to quantify.</p>
<p>To provide an alternative data-driven measure of compactness, the
<code>desplim</code> package includes a compactness score that directly
models this human intuition. Our approach is based on the work of <a href="https://doi.org/10.1111/ajps.12603" class="external-link">Kaufman et al. (2021)</a> who
successfully trained a model on human rankings of district shapes using
common geometric features.</p>
<p>The algorithm may need to calculate several thousands, if not
millions, of compactness scores during complex split-merge problems. For
this reason, we built our own lightweight and computationally efficient
model using <a href="https://cran.r-project.org/web/packages/xgboost/index.html" class="external-link">XGBoost</a>.</p>
<p>This vignette provides an overview of how the metric was developed,
using the original <a href="https://doi.org/10.7910/DVN/FA8FVF" class="external-link">replication data</a> and the
<a href="https://www.tidymodels.org/" class="external-link">tidyverse</a> framework.</p>
<div class="section level2">
<h2 id="data-and-setup">1. Data and Setup<a class="anchor" aria-label="anchor" href="#data-and-setup"></a>
</h2>
<p>A cleaned and pre-processed version of this dataset is included
directly in <code>desplim</code> as <code>compact_train</code>.</p>
<p>First, let’s load the libraries required for modeling and
diagnostics.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://thesixmax.github.io/desplim/">desplim</a></span><span class="op">)</span> <span class="co"># contains the cleaned training data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a></span><span class="op">)</span> <span class="co"># core framework for modelling and pre-processing</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost" class="external-link">xgboost</a></span><span class="op">)</span> <span class="co"># model engine</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://modeloriented.github.io/DALEX/" class="external-link">DALEX</a></span><span class="op">)</span> <span class="co"># model explainability</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ModelOriented.github.io/DALEXtra/" class="external-link">DALEXtra</a></span><span class="op">)</span> <span class="co"># helper for DALEX</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://doFuture.futureverse.org" class="external-link">doFuture</a></span><span class="op">)</span> <span class="co"># parallel processing</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set up parallel processing</span></span>
<span><span class="fu"><a href="https://doFuture.futureverse.org/reference/registerDoFuture.html" class="external-link">registerDoFuture</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span>logical <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="va">n_cores</span><span class="op">)</span></span></code></pre></div>
<p>The <code>compact_train</code> data contains the human-assigned
compactness score (<code>compact</code>), ranging from 0 (least compact)
to 1 (most compact) and 10 geometric features for 547 unique district
shapes.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">compact_train</span><span class="op">)</span></span>
<span><span class="co">#&gt;     compact     boyce box_reock      hull   len_wid    polsby     reock</span></span>
<span><span class="co">#&gt; 1 0.0300000 0.7649550 0.4896064 0.6262075 0.7534825 0.1145953 0.4057489</span></span>
<span><span class="co">#&gt; 2 0.2745098 0.7775373 0.4381054 0.6984327 0.8969073 0.2021440 0.3742773</span></span>
<span><span class="co">#&gt; 3 0.1300000 0.8304922 0.4871881 0.6415116 0.8888942 0.1258987 0.3280131</span></span>
<span><span class="co">#&gt; 4 0.1400000 0.8341214 0.4310280 0.6125937 0.6679481 0.1873192 0.3345650</span></span>
<span><span class="co">#&gt; 5 0.0100000 0.7016934 0.4300677 0.5800668 0.9635191 0.1019103 0.4143697</span></span>
<span><span class="co">#&gt; 6 0.1176471 0.8371308 0.3508467 0.5589451 0.3416772 0.1458956 0.1486579</span></span>
<span><span class="co">#&gt;    schwartz      skew     sym_x     sym_y</span></span>
<span><span class="co">#&gt; 1 0.3385193 0.2822636 0.6494468 0.5977191</span></span>
<span><span class="co">#&gt; 2 0.4496043 0.4190817 0.6090472 0.6896901</span></span>
<span><span class="co">#&gt; 3 0.3548220 0.2738264 0.5287228 0.5271888</span></span>
<span><span class="co">#&gt; 4 0.4328039 0.3005736 0.4305575 0.3530961</span></span>
<span><span class="co">#&gt; 5 0.3192339 0.2754020 0.4761292 0.4987708</span></span>
<span><span class="co">#&gt; 6 0.3819629 0.1683645 0.6358400 0.4629123</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">compact_train</span><span class="op">$</span><span class="va">compact</span><span class="op">)</span></span></code></pre></div>
<p><img src="desplim-compactness_files/figure-html/explore-hist-1.png" width="700"></p>
<p>The histogram shows a relatively uniform distribution of compactness
scores, which is ideal for training a model that can recognise the full
spectrum from non-compact to highly compact shapes. As the output
suggests, no single geometric feature appears to be a perfect predictor
on its own.</p>
<p>The following plots show three sample districts from the dataset: one
of the least compact, one with a medium score, and one of the most
compact.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.4.0; sf_use_s2() is TRUE</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/get_theme.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Find districts with high, medium, and low compactness</span></span>
<span><span class="va">highly_compact</span> <span class="op">&lt;-</span> <span class="va">kaufman_25</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_max</a></span><span class="op">(</span>order_by <span class="op">=</span> <span class="va">compact</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">moderately_compact</span> <span class="op">&lt;-</span> <span class="va">kaufman_25</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html" class="external-link">between</a></span><span class="op">(</span><span class="va">compact</span>, <span class="fl">0.4</span>, <span class="fl">0.6</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">non_compact</span> <span class="op">&lt;-</span> <span class="va">kaufman_25</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_min</a></span><span class="op">(</span>order_by <span class="op">=</span> <span class="va">compact</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create plots</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">highly_compact</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"High:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">highly_compact</span><span class="op">$</span><span class="va">compact</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">moderately_compact</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Medium:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">moderately_compact</span><span class="op">$</span><span class="va">compact</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">non_compact</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Low:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">non_compact</span><span class="op">$</span><span class="va">compact</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span> <span class="va">p3</span></span></code></pre></div>
<p><img src="desplim-compactness_files/figure-html/explore-districts-1.png" width="700"></p>
<p>As the plots demonstrate, the scores align well with our visual
intuition. The district with the low score is the most “irregular”,
while the district with the high score is much more “regular”.</p>
<p>We’ll split the data into a training set (80%) and a testing set
(20%). We stratify by the compact variable to ensure both sets have a
similar distribution of scores.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="co"># Data split</span></span>
<span><span class="va">data_split</span> <span class="op">&lt;-</span> <span class="fu">initial_split</span><span class="op">(</span><span class="va">compact_train</span>, prop <span class="op">=</span> <span class="fl">0.8</span>, strata <span class="op">=</span> <span class="va">compact</span><span class="op">)</span></span>
<span><span class="va">train_data</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">data_split</span><span class="op">)</span></span>
<span><span class="va">test_data</span> <span class="op">&lt;-</span> <span class="fu">testing</span><span class="op">(</span><span class="va">data_split</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Recipe</span></span>
<span><span class="va">model_recipe</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">compact</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="model-specification-and-tuning">2. Model specification and tuning<a class="anchor" aria-label="anchor" href="#model-specification-and-tuning"></a>
</h2>
<p>With the data prepared, we can train a model to predict the
compactness score based on the 10 geometric features. We’ll use the well
known XGBoost algorithm for this task. The process involves three main
steps: building a workflow, tuning hyperparameters, and finalising the
model.</p>
<div class="section level3">
<h3 id="modelling-workflow">2.1 Modelling workflow<a class="anchor" aria-label="anchor" href="#modelling-workflow"></a>
</h3>
<p>First, we define our model specification using tidymodels. We mark
standard hyperparameters for tuning, which allows us to find the best
combination for our data. For more information, the documentation on the
<a href="https://tune.tidymodels.org/index.html" class="external-link">tune package</a> comes
in handy. For the parameter specification, we apply the defaults
provided by the <a href="https://dials.tidymodels.org/" class="external-link">dials
package</a>.</p>
<p>We then bundle our (simple) pre-processing recipe and the model
specification into a single workflow object. Finally, we create a
10-fold cross-validation.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># XGBoost specification</span></span>
<span><span class="va">xgb_spec</span> <span class="op">&lt;-</span> <span class="fu">boost_tree</span><span class="op">(</span></span>
<span>  trees <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  tree_depth <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  learn_rate <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  mtry <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  min_n <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  loss_reduction <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  sample_size <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span></span>
<span>    <span class="st">"xgboost"</span>,</span>
<span>    objective <span class="op">=</span> <span class="st">"reg:squarederror"</span>,</span>
<span>    verbose <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># XGBoost parameter specification</span></span>
<span><span class="va">xgb_params</span> <span class="op">&lt;-</span> <span class="fu">parameters</span><span class="op">(</span></span>
<span>  <span class="fu">trees</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">tree_depth</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">learn_rate</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">finalize</span><span class="op">(</span><span class="fu">mtry</span><span class="op">(</span><span class="op">)</span>, <span class="va">train_data</span><span class="op">)</span>,</span>
<span>  <span class="fu">min_n</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">loss_reduction</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">sample_prop</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Workflow</span></span>
<span><span class="va">xgb_workflow</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">model_recipe</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">xgb_spec</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Cross validation</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span><span class="va">cv_folds</span> <span class="op">&lt;-</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">train_data</span>, v <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="bayesian-hyperparameter-tuning">2.2 Bayesian hyperparameter tuning<a class="anchor" aria-label="anchor" href="#bayesian-hyperparameter-tuning"></a>
</h3>
<p>Instead of testing every possible combination of parameters (through
a grid search), we’ll use Bayesian optimisation. This is an adaptive
method that uses the results from past iterations to search for the most
promising future parameter combinations.</p>
<p>The baseline is 100 iterations, but it will stop early if it doesn’t
find a better model after 20 rounds. We’ll use Root Mean Squared Error
(RMSE) as the primary metric to optimise.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">789</span><span class="op">)</span></span>
<span><span class="va">tune_results</span> <span class="op">&lt;-</span> <span class="fu">tune_bayes</span><span class="op">(</span></span>
<span>  <span class="va">xgb_workflow</span>,</span>
<span>  resamples <span class="op">=</span> <span class="va">cv_folds</span>,</span>
<span>  param_info <span class="op">=</span> <span class="va">xgb_params</span>,</span>
<span>  initial <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  iter <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  metrics <span class="op">=</span> <span class="fu">metric_set</span><span class="op">(</span><span class="va">rmse</span>, <span class="va">mae</span><span class="op">)</span>,</span>
<span>  control <span class="op">=</span> <span class="fu">control_bayes</span><span class="op">(</span></span>
<span>    verbose_iter <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    save_pred <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    save_workflow <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    uncertain <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    no_improve <span class="op">=</span> <span class="fl">20</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="finalising-the-model">2.3 Finalising the model<a class="anchor" aria-label="anchor" href="#finalising-the-model"></a>
</h3>
<p>Once the tuning process is complete, we select the parameters that
resulted in the lowest RMSE. We then use the <code>last_fit()</code>
function, which is a convenient helper that performs the final two
steps:</p>
<ul>
<li><p>Fits the finalised workflow (with the best parameters) on the
entire training set.</p></li>
<li><p>Evaluates the performance of this final model on the held-out
test set.</p></li>
</ul>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Select the best parameters</span></span>
<span><span class="va">best_params</span> <span class="op">&lt;-</span> <span class="fu">select_best</span><span class="op">(</span><span class="va">tune_results</span>, metric <span class="op">=</span> <span class="st">"rmse"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 8</span></span></span>
<span><span class="co">#&gt;   trees tree_depth learn_rate  mtry min_n loss_reduction sample_size .config</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>   973          2    0.009<span style="text-decoration: underline;">38</span>     4     3  0.000<span style="text-decoration: underline;">000</span>001<span style="text-decoration: underline;">43</span>       0.202 iter033</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Finalise the workflow</span></span>
<span><span class="va">final_xgb_wf</span> <span class="op">&lt;-</span> <span class="fu">finalize_workflow</span><span class="op">(</span><span class="va">xgb_workflow</span>, <span class="va">best_params</span><span class="op">)</span></span>
<span><span class="va">final_fit</span> <span class="op">&lt;-</span> <span class="fu">last_fit</span><span class="op">(</span><span class="va">final_xgb_wf</span>, <span class="va">data_split</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="model-performance">3. Model performance<a class="anchor" aria-label="anchor" href="#model-performance"></a>
</h2>
<p>Having a final, trained model, we need to evaluate its performance on
the held-out test data. This tells us how well the model is likely to
perform on new, unseen districts.</p>
<div class="section level3">
<h3 id="overall-performance-metrics">3.1 Overall performance metrics<a class="anchor" aria-label="anchor" href="#overall-performance-metrics"></a>
</h3>
<p>First, we’ll examine the summary performance metrics. The
<code>collect_metrics()</code> function gives us the Root Mean Squared
Error (RMSE) and the R-squared from the test set.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute test metrics</span></span>
<span><span class="va">test_metrics</span> <span class="op">&lt;-</span> <span class="fu">collect_metrics</span><span class="op">(</span><span class="va">final_fit</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">test_metrics</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 4</span></span></span>
<span><span class="co">#&gt;   .metric .estimator .estimate .config        </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> rmse    standard      0.099<span style="text-decoration: underline;">7</span> pre0_mod0_post0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> rsq     standard      0.885  pre0_mod0_post0</span></span></code></pre></div>
<p>The low RMSE and high R-squared indicate that the model’s predictions
are, on average, very close to our target compactness scores.</p>
</div>
<div class="section level3">
<h3 id="predicted-versus-actual-scores">3.2 Predicted versus actual scores<a class="anchor" aria-label="anchor" href="#predicted-versus-actual-scores"></a>
</h3>
<p>Metrics give us a high-level summary, but a plot of predicted versus
actual values helps us better understand the model predictions across
compactness scores.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Collect the individual predictions on the test set</span></span>
<span><span class="va">test_predictions</span> <span class="op">&lt;-</span> <span class="fu">collect_predictions</span><span class="op">(</span><span class="va">final_fit</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create the plot</span></span>
<span><span class="va">predicted_vs_actual_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="va">test_predictions</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">compact</span>, y <span class="op">=</span> <span class="va">.pred</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="st">"dodgerblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>lty <span class="op">=</span> <span class="fl">2</span>, color <span class="op">=</span> <span class="st">"red"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Predicted vs. actual compactness"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Actual compactness"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Predicted compactness"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">predicted_vs_actual_plot</span><span class="op">)</span></span></code></pre></div>
<p><img src="desplim-compactness_files/figure-html/plot-test_predictions-1.png" width="700"></p>
<p>The plot confirms the presumed good performance. Aside from a few
outliers, there are no major areas where the model systematically over-
or under-predicts, suggesting it generalises well across the entire
range of compactness scores.</p>
</div>
<div class="section level3">
<h3 id="feature-importance">3.3 Feature importance<a class="anchor" aria-label="anchor" href="#feature-importance"></a>
</h3>
<p>Finally, we want to understand what geometric features the model
relies on most to make its predictions. We can calculate feature
importance by measuring how much the model’s prediction error increases
when a single feature’s values are randomly shuffled.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract the finalised and trained workflow</span></span>
<span><span class="va">final_trained_workflow</span> <span class="op">&lt;-</span> <span class="fu">extract_workflow</span><span class="op">(</span><span class="va">final_fit</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create DALEX explainer and feature importance</span></span>
<span><span class="va">train_predictors</span> <span class="op">&lt;-</span> <span class="va">train_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">compact</span><span class="op">)</span></span>
<span><span class="va">train_outcome</span> <span class="op">&lt;-</span> <span class="va">train_data</span><span class="op">$</span><span class="va">compact</span></span>
<span><span class="va">explainer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ModelOriented.github.io/DALEXtra/reference/explain_tidymodels.html" class="external-link">explain_tidymodels</a></span><span class="op">(</span></span>
<span>  <span class="va">final_trained_workflow</span>,</span>
<span>  data <span class="op">=</span> <span class="va">train_predictors</span>,</span>
<span>  y <span class="op">=</span> <span class="va">train_outcome</span>,</span>
<span>  label <span class="op">=</span> <span class="st">"XGBoost"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">feature_importance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/model_parts.html" class="external-link">model_parts</a></span><span class="op">(</span><span class="va">explainer</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create summary dataframe</span></span>
<span><span class="va">importance_summary_df</span> <span class="op">&lt;-</span> <span class="va">feature_importance</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">variable</span> <span class="op">!=</span> <span class="st">"_baseline_"</span> <span class="op">&amp;</span> <span class="va">variable</span> <span class="op">!=</span> <span class="st">"_full_model_"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">variable</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    mean_dropout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dropout_loss</span><span class="op">)</span>,</span>
<span>    min_dropout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">dropout_loss</span><span class="op">)</span>,</span>
<span>    max_dropout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dropout_loss</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Create plot</span></span>
<span><span class="va">feature_importance_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="va">importance_summary_df</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">mean_dropout</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html" class="external-link">reorder</a></span><span class="op">(</span><span class="va">variable</span>, <span class="va">mean_dropout</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbarh</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">min_dropout</span>, xmax <span class="op">=</span> <span class="va">max_dropout</span><span class="op">)</span>,</span>
<span>    height <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"gray50"</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">0.9</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    color <span class="op">=</span> <span class="st">"darkred"</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">3</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Feature importance"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"Increase in RMSE after feature shuffling"</span>,</span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; Warning: `geom_errobarh()` was deprecated in ggplot2 4.0.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please use the `orientation` argument of `geom_errorbar()` instead.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">feature_importance_plot</span><span class="op">)</span></span>
<span><span class="co">#&gt; `height` was translated to `width`.</span></span></code></pre></div>
<p><img src="desplim-compactness_files/figure-html/feature-importance-1.png" width="700"></p>
<p>The results clearly show that Polsby-Popper and Convex Hull are the
two most influential features. This aligns with their common usage in
(re-)districting analysis and their relation to what is typically
perceived as compact. However, all features play a role in predicting
the compactness score, justifying a more nuanced model setup.</p>
</div>
</div>
<div class="section level2">
<h2 id="usage">4. Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<p>This model is now available in the package through the
<code><a href="../reference/desplim_compactness.html">desplim_compactness()</a></code> function.</p>
<p>The final test is to see how the model’s predictions compare to the
original compactness scores on the example districts.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Apply desplim_compactness to the original example districts</span></span>
<span><span class="va">score_high</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/desplim_compactness.html">desplim_compactness</a></span><span class="op">(</span><span class="va">highly_compact</span><span class="op">)</span><span class="op">$</span><span class="va">compactness</span></span>
<span><span class="va">score_moderate</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/desplim_compactness.html">desplim_compactness</a></span><span class="op">(</span><span class="va">moderately_compact</span><span class="op">)</span><span class="op">$</span><span class="va">compactness</span></span>
<span><span class="va">score_low</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/desplim_compactness.html">desplim_compactness</a></span><span class="op">(</span><span class="va">non_compact</span><span class="op">)</span><span class="op">$</span><span class="va">compactness</span></span>
<span></span>
<span><span class="co"># Create comparison plots</span></span>
<span><span class="va">p1_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">highly_compact</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span></span>
<span>    <span class="st">"High Compactness"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>      <span class="st">"Original: "</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">highly_compact</span><span class="op">$</span><span class="va">compact</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      <span class="st">"\nModel: "</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">score_high</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">moderately_compact</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span></span>
<span>    <span class="st">"Medium Compactness"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>      <span class="st">"Original: "</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">moderately_compact</span><span class="op">$</span><span class="va">compact</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      <span class="st">"\nModel: "</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">score_moderate</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">non_compact</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span></span>
<span>    <span class="st">"Low Compactness"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>      <span class="st">"Original: "</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">non_compact</span><span class="op">$</span><span class="va">compact</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      <span class="st">"\nModel: "</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">score_low</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1_final</span> <span class="op">+</span> <span class="va">p2_final</span> <span class="op">+</span> <span class="va">p3_final</span></span></code></pre></div>
<p><img src="desplim-compactness_files/figure-html/usage-1.png" width="700"></p>
<p>As we can see, the scores from the <code><a href="../reference/desplim_compactness.html">desplim_compactness()</a></code>
function are very close to the original compactness scores.</p>
<p>Finally, we can investigate the example district with the largest
deviance between the model prediction and actual compactness score. We
set <code>keep_metrics = TRUE</code> in the
<code><a href="../reference/desplim_compactness.html">desplim_compactness()</a></code> function. This returns not just the
final score, but also the 10 underlying geometric features, which is
useful for diagnosing specific cases.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate deviances</span></span>
<span><span class="va">compare_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/desplim_compactness.html">desplim_compactness</a></span><span class="op">(</span><span class="va">kaufman_25</span>, keep_metrics <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>deviance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">compact</span> <span class="op">-</span> <span class="va">compactness</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Find the district with the largest deviance</span></span>
<span><span class="va">max_deviance</span> <span class="op">&lt;-</span> <span class="va">compare_scores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_max</a></span><span class="op">(</span>order_by <span class="op">=</span> <span class="va">deviance</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the result</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">max_deviance</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"firebrick"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span></span>
<span>    <span class="st">"Largest deviance in example data"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>      <span class="st">"Original score: "</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">max_deviance</span><span class="op">$</span><span class="va">compact</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      <span class="st">"\nModel score: "</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">max_deviance</span><span class="op">$</span><span class="va">compactness</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      <span class="st">"\nDeviance: "</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">max_deviance</span><span class="op">$</span><span class="va">deviance</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="desplim-compactness_files/figure-html/deviance-1.png" width="700"></p>
<p>The main reason for the high deviance is the disagreement between the
different geometrical feaures of the district:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">max_deviance</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 1 feature and 13 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -88.02823 ymin: 42.12151 xmax: -87.88505 ymax: 42.36036</span></span>
<span><span class="co">#&gt; Geodetic CRS:  NAD83</span></span>
<span><span class="co">#&gt;     compact     boyce box_reock      hull   len_wid    polsby     reock</span></span>
<span><span class="co">#&gt; 1 0.4509804 0.7310901 0.3964636 0.5551677 0.4437754 0.1500558 0.2241015</span></span>
<span><span class="co">#&gt;    schwartz      skew     sym_x     sym_y compactness  deviance</span></span>
<span><span class="co">#&gt; 1 0.3873703 0.2151164 0.4948946 0.4713435   0.1758566 0.2751238</span></span>
<span><span class="co">#&gt;                         geometry</span></span>
<span><span class="co">#&gt; 1 POLYGON ((-88.02823 42.2698...</span></span></code></pre></div>
<p>The shape has a very low polsby score (indicating a highly complex
perimeter), while other features are not as low. This example doesn’t
indicate model failure. It rather highlights that the model is sensitive
to perimeter complexity.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://sessioninfo.r-lib.org/reference/session_info.html" class="external-link">session_info</a></span><span class="op">(</span>pkgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"attached"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB; font-weight: bold;">─ Session info ───────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt;  <span style="color: #555555; font-style: italic;">setting </span> <span style="color: #555555; font-style: italic;">value</span></span></span>
<span><span class="co">#&gt;  version  R version 4.5.1 (2025-06-13)</span></span>
<span><span class="co">#&gt;  os       Ubuntu 24.04.3 LTS</span></span>
<span><span class="co">#&gt;  system   x86_64, linux-gnu</span></span>
<span><span class="co">#&gt;  ui       X11</span></span>
<span><span class="co">#&gt;  language en</span></span>
<span><span class="co">#&gt;  collate  C.UTF-8</span></span>
<span><span class="co">#&gt;  ctype    C.UTF-8</span></span>
<span><span class="co">#&gt;  tz       UTC</span></span>
<span><span class="co">#&gt;  date     2025-09-13</span></span>
<span><span class="co">#&gt;  pandoc   3.1.11 @ /opt/hostedtoolcache/pandoc/3.1.11/x64/ (via rmarkdown)</span></span>
<span><span class="co">#&gt;  quarto   NA</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB; font-weight: bold;">─ Packages ───────────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt;  <span style="color: #555555; font-style: italic;">package      </span> <span style="color: #555555; font-style: italic;">*</span> <span style="color: #555555; font-style: italic;">version </span> <span style="color: #555555; font-style: italic;">date (UTC)</span> <span style="color: #555555; font-style: italic;">lib</span> <span style="color: #555555; font-style: italic;">source</span></span></span>
<span><span class="co">#&gt;  broom         * 1.0.9    <span style="color: #555555;">2025-07-28</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  DALEX         * 2.5.2    <span style="color: #555555;">2025-07-27</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  DALEXtra      * 2.3.0    <span style="color: #555555;">2023-05-26</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  desplim       * 0.1.0    <span style="color: #555555;">2025-09-13</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">local</span></span></span>
<span><span class="co">#&gt;  devtools      * 2.4.5    <span style="color: #555555;">2022-10-11</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  dials         * 1.4.2    <span style="color: #555555;">2025-09-04</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  doFuture      * 1.1.2    <span style="color: #555555;">2025-07-14</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  dplyr         * 1.1.4    <span style="color: #555555;">2023-11-17</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  foreach       * 1.5.2    <span style="color: #555555;">2022-02-02</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  future        * 1.67.0   <span style="color: #555555;">2025-07-29</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  geos          * 0.2.4    <span style="color: #555555;">2023-11-30</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  ggplot2       * 4.0.0    <span style="color: #555555;">2025-09-11</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  infer         * 1.0.9    <span style="color: #555555;">2025-06-26</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  modeldata     * 1.5.1    <span style="color: #555555;">2025-08-22</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  parsnip       * 1.3.3    <span style="color: #555555;">2025-08-31</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  patchwork     * 1.3.2    <span style="color: #555555;">2025-08-25</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  purrr         * 1.1.0    <span style="color: #555555;">2025-07-10</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  recipes       * 1.3.1    <span style="color: #555555;">2025-05-21</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  redistmetrics * 1.0.9    <span style="color: #555555;">2025-04-29</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  rsample       * 1.3.1    <span style="color: #555555;">2025-07-29</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  scales        * 1.4.0    <span style="color: #555555;">2025-04-24</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  sf            * 1.0-21   <span style="color: #555555;">2025-05-15</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  tailor        * 0.1.0    <span style="color: #555555;">2025-08-25</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  tidymodels    * 1.4.1    <span style="color: #555555;">2025-09-08</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  tidyr         * 1.3.1    <span style="color: #555555;">2024-01-24</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  tune          * 2.0.0    <span style="color: #555555;">2025-09-01</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  usethis       * 3.2.1    <span style="color: #555555;">2025-09-06</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  workflows     * 1.3.0    <span style="color: #555555;">2025-08-27</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  workflowsets  * 1.1.1    <span style="color: #555555;">2025-05-27</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  xgboost       * 1.7.11.1 <span style="color: #555555;">2025-05-15</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt;  yardstick     * 1.3.2    <span style="color: #555555;">2025-01-22</span> <span style="color: #555555;">[1]</span> <span style="color: #BB00BB; font-weight: bold;">RSPM</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #555555;"> [1] /home/runner/work/_temp/Library</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;"> [2] /opt/R/4.5.1/lib/R/site-library</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;"> [3] /opt/R/4.5.1/lib/R/library</span></span></span>
<span><span class="co">#&gt;  <span style="color: #BBBBBB; background-color: #BB0000;">*</span> ── Packages attached to the search path.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB; font-weight: bold;">──────────────────────────────────────────────────────────────────────────────</span></span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sixten Maximillian Thestrup.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
